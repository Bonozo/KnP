function GoldPurchase(e){function t(){if("iPhone OS"==Titanium.Platform.name){var e=Titanium.Platform.version.split("."),t=parseInt(e[0],10);if(t>=7)return!0}return!1}function i(e){Ti.API.info("< -- > "+e)}function n(e){switch(e){case m.RESULT_OK:return"OK";case m.RESULT_USER_CANCELED:return"USER CANCELED";case m.RESULT_SERVICE_UNAVAILABLE:return"SERVICE UNAVAILABLE";case m.RESULT_BILLING_UNAVAILABLE:return"BILLING UNAVAILABLE";case m.RESULT_ITEM_UNAVAILABLE:return"ITEM UNAVAILABLE";case m.RESULT_DEVELOPER_ERROR:return"DEVELOPER ERROR";case m.RESULT_ERROR:return"RESULT ERROR"}return""}function o(e){switch(e){case m.SIGNATURE_VERIFIED:return"SIGNATURE VERIFIED";case m.NULL_DATA:return"NULL DATA";case m.SIGNATURE_ERROR:return"SIGNATURE ERROR";case m.UNKNOWN_NONCE:return"UNKNOWN NONCE";case m.PUBLIC_KEY_NULL:return"PUBLIC KEY NULL"}return""}function a(e){n(e.responseCode);Ti.API.info("Request Id: "+e.requestId),Ti.API.info("Response code: "+e.responseCode)}function r(){T+=1,1==T&&I.show()}function d(){T>0&&(T-=1,0==T&&I.hide())}function s(e){Ti.API.info("Marking as purchased: "+e),E[e]=!0,Ti.App.Properties.setBool("Purchased-"+e,!0)}function c(e,t){r(),p.requestProducts([e],function(e){d(),e.success?e.invalid?alert("ERROR: We requested an invalid product!"):t(e.products[0]):alert("ERROR: We failed to talk to Apple!")})}function l(e){r(),p.purchase(e)}var u=Ti.UI.createWindow({backgroundImage:"/assets/inventoryBackground.png",navBarHidden:!0,fullscreen:!0,zIndex:200});u.orientationModes=[Ti.UI.PORTRAIT,Ti.UI.UPSIDE_PORTRAIT];{var p,f=Ti.Platform.osname,g=0;t()}if("android"===f){!function(){alert("true")}();var m=require("ti.inappbilling"),h="android.test.purchased";m.addEventListener(m.ON_BIND_EVENT,function(e){e.result==m.SUCCESS?i("Billing Service Bound"):i("Billing Service Bind Failed")}),m.addEventListener(m.ON_CONNECT_EVENT,function(){for(var e=0;e<w.length;e++)w[e].enabled=!0}),m.addEventListener(m.RESPONSE_EVENT,function(e){e.sync||(i("RESPONSE CALLED "+e.requestId+e.responseCode),Ti.API.info("RESPONSE CALLED \nRequest Id:\n"+e.requestId+" \nResponse Code:"+n(e.responseCode)))}),m.addEventListener(m.PURCHASE_STATE_CHANGED_EVENT,function(t){if(i("PURCHASE STATE CHANGED CALLED "+t.signedData+" "+t.signature+"\nSECURITY RESULT "+t.result),Ti.API.info("PURCHASE STATE CHANGED CALLED"),Ti.API.info("Signature Verification Result:\n"+o(t.result)),Ti.API.info("Signed Data:\n"+t.signedData),null!=t.signedData){var n=JSON.parse(t.signedData);if(n.orders[0]&&n.orders[0].notificationId){var r=m.confirmNotifications({notificationIds:[n.orders[0].notificationId]});a(r)}var d="http://bonozo.com:8080/knp/purchase_gold.php?uid="+e.Record[0].UID+"&num_of_golds="+g,s=require("/ui/common/Functions/function");s.requestServer({success:function(){items_json=JSON.parse(this.responseText),""!=items_json.Message&&(alert("Successfully Purchased!"),Ti.App.fireEvent("update_footer",{clicked_item:"KnPStore"}))},method:"GET",contentType:"text/xml",url:d})}}),m.addEventListener(m.NOTIFY_EVENT,function(e){Ti.API.info("NOTIFY CALLED \nNotify Id:\n"+e.notifyId);var t=m.getPurchaseInformation({notificationIds:[e.notifyId]});a(t)}),m.startBillingService()}else{p=require("ti.storekit"),p.receiptVerificationSandbox="production"!==Ti.App.deployType;var I=Ti.UI.createActivityIndicator({bottom:10,height:50,width:50,backgroundColor:"black",borderRadius:10,style:Ti.UI.iPhone.ActivityIndicatorStyle.BIG}),T=0;u.add(I);var E={};p.addEventListener("transactionState",function(t){switch(d(),t.state){case p.FAILED:t.cancelled?alert("Purchase cancelled"):alert("ERROR: Buying failed! "+t.message);break;case p.PURCHASED:verifyingReceipts?p.verifyReceipt(t,function(e){e.success?e.valid?(alert("Thanks! Receipt Verified"),s(t.productIdentifier)):alert("Sorry. Receipt is invalid"):alert(e.message)}):(alert("Thanks!"),s(t.productIdentifier));var i="http://bonozo.com:8080/knp/purchase_gold.php?uid="+e.Record[0].UID+"&num_of_golds="+g,n=require("/ui/common/Functions/function");n.requestServer({success:function(){items_json=JSON.parse(this.responseText),""!=items_json.Message&&(alert("Successfully Purchased!"),Ti.App.fireEvent("update_footer",{clicked_item:"KnPStore"}))},method:"GET",contentType:"text/xml",url:i});break;case p.PURCHASING:Ti.API.info("Purchasing "+t.productIdentifier);break;case p.RESTORED:Ti.API.info("Restored "+t.productIdentifier)}}),p.addEventListener("restoredCompletedTransactions",function(e){if(d(),e.error)alert(e.error);else if(null==e.transactions||0==e.transactions.length)alert("There were no purchases to restore!");else{for(var t=0;t<e.transactions.length;t++)verifyingReceipts?p.verifyReceipt(e.transactions[t],function(e){e.valid?s(e.productIdentifier):Ti.API.error("Restored transaction is not valid")}):s(e.transactions[t].productIdentifier);alert("Restored "+e.transactions.length+" purchases!")}})}var v=Ti.UI.createImageView({image:"/assets/overlayPlayerInfoCroped.png",height:"6.4%",width:"100%",bottom:"94.6%"});u.add(v);var _=Titanium.Platform.displayCaps.platformWidth,R=(Titanium.Platform.displayCaps.platformHeight,Ti.UI.createView(),Titanium.UI.createView({backgroundColor:"#FFFFFF",borderRadius:10,borderColor:"#333333",borderWidth:"5dip",visible:!1,height:"8%",width:_/2,zIndex:700})),b=Ti.UI.createActivityIndicator({color:"#333333",font:{fontSize:"14dip",fontWeight:"bold"},message:"Loading...",style:"iPhone OS"===Ti.Platform.name?Ti.UI.iPhone.ActivityIndicatorStyle.DARK:Ti.UI.ActivityIndicatorStyle.DARK,height:"100%",width:"100%"});R.add(b),u.add(R),b.show(),R.visible=!0;var A=Titanium.UI.createLabel({text:"Purchase Gold",top:"0",height:"3.1%",left:"3%",textAlign:"left",color:"#5afd9b",font:{fontWeight:"bold",fontSize:"12dip"}});u.add(A);var U=Titanium.UI.createLabel({text:"Back",top:"0",height:"3.1%",right:"15.6%",textAlign:"right",color:"#5afd9b",font:{fontSize:"12dip"}});u.add(U);var S=Ti.UI.createImageView({image:"/assets/iconReturn.png",height:"8%",width:"11.6%",top:"1%",right:"3%"});u.add(S),S.addEventListener("click",function(){u.close()});var w=[],x="http://bonozo.com:8080/knp/get_gold_prices.php",L=[],N=require("/ui/common/Functions/function");return N.requestServer({success:function(){items_json=JSON.parse(this.responseText);for(var e=.136*_,t=0;t<items_json.Record.length;t++){var i=Ti.UI.createTableViewRow({height:e,className:"gold_prices",zIndex:500}),n=Ti.UI.createImageView({image:"/assets/iconGoldMini.png",width:"13%",left:"5px"});i.add(n);var o=Ti.UI.createLabel({text:items_json.Record[t].NUM_OF_GOLDS+" Golds",font:{fontSize:"16dip"},color:"#5afd9b",left:"15%",width:"45%"});i.add(o),w[t]=Titanium.UI.createButton({title:"$"+items_json.Record[t].PRICE+"\nBuy",width:"25%",height:"80%",color:"#000000",font:{fontSize:"12dip"},product_id:items_json.Record[t].PRODUCT_ID,num_of_golds:items_json.Record[t].NUM_OF_GOLDS,right:"5%",backgroundImage:"/assets/button_small_UP.png"}),i.add(w[t]),w[t].addEventListener("click",function(e){e.source.product_id;g=e.source.num_of_golds;var t=Titanium.UI.createAlertDialog({title:"Click 'Yes' to Purchase.",message:"Are you Sure?",buttonNames:["Yes","No"],cancel:1});t.show(),t.addEventListener("click",function(e){if(Titanium.API.info("e = "+JSON.stringify(e)),e.cancel!==e.index&&e.cancel!==!0)switch(e.index){case 0:if("android"===f){var t=m.requestPurchase({productId:h});a(t)}else p.canMakePayments?c("HundredGolds",function(e){l(e)}):alert("This device cannot make purchases!");break;case 1:}})});{Ti.UI.createLabel({text:items_json.Record[t].PRICE,top:"10%",left:"90%",font:{fontSize:"10dip"},color:"#59fe9a"})}L.push(i)}var r=Ti.UI.createTableView({backgroundColor:"transparent",separatorColor:"transparent",data:L,width:"100%",height:"72.3%",top:"10%"});u.add(r),b.hide(),R.visible=!1},method:"GET",contentType:"text/xml",url:x}),i("Starting Billing Service"),u}module.exports=GoldPurchase;