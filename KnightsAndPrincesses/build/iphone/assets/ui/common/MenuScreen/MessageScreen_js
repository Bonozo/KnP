function MessageScreen(e,t,i,n,o){function a(e,t){return Math.floor(Math.random()*(t-e+1))+e}function r(e,t,i,n,o){var a=0,r=t,d=0;s(e,r,30,function(t,r,s){x=s*w*100,a=s*w+w,d=a+w;var c=Ti.UI.createView({backgroundColor:"#72AE94",borderColor:"#376b54",borderWidth:1,borderRadius:5,height:a,top:"10%",bottom:"10%",left:n?"26%":"4%",width:"72%"}),l=Ti.UI.createLabel({text:r,textAlign:"left",font:{fontSize:"14dip"},color:"#FFFFFF",left:"4%",top:"4%"}),u=Ti.UI.createLabel({text:"\n"+i,color:"#d0f6d9",font:{fontSize:"12dip"},bottom:"1%",left:"4%",textAlign:"left"});c.add(l),c.add(u),o(e,c,d)})}function s(e,t,i,n){for(var o=t.split(" "),a=1,r=0,s="",d=0;d<o.length;d++)r+o[d].length+1>=i&&(s+="\n",a++,r=0),r+=o[d].length+1,s+=o[d]+" ";n(e,s,a)}function d(e,t,i,n,a){var s=Titanium.UI.createTableViewRow({className:"FriendMessage",width:"100%",allowsSelection:!1}),d=!1;g({width:100,height:100,top:-20,left:"70%"},o.Record[0].USER_APPEARANCE,o.Record[0].GENDER,0,function(e){null!=y&&s.add(e)}),r(0,i,a,d,function(e,t,i){s.add(t),s.height=i,A.push(s),R.data=A,R.scrollToIndex(A.length-1,{position:Titanium.UI.iPhone.TableViewScrollPosition.TOP,animated:!0})})}function c(t,i,n){I.show(),T.visible=!0,I.message="Message sending...";var o=require("/ui/common/Functions/function");o.requestServer({success:function(){if(Message_info=JSON.parse(this.responseText),void 0!=Message_info.Message){P=Message_info.Message[0].DATETIME;var t=Titanium.UI.createTableViewRow({className:"MyMessage",width:"100%",allowsSelection:!1}),i=!0;g({width:100,height:100,top:-20,left:0},e.Record[0].USER_APPEARANCE,e.Record[0].GENDER,0,function(e){null!=y&&t.add(e)}),r(0,n,P,i,function(e,i,n){t.add(i),t.height=n,A.push(t),R.data=A,R.scrollToIndex(A.length-1,{position:Titanium.UI.iPhone.TableViewScrollPosition.TOP,animated:!0}),I.hide(),T.visible=!1})}else alert("Oops... something went wrong.\nPlease restart game.")},method:"GET",contentType:"text/xml",url:"http://bonozo.com:8080/knp/send_message.php?sender_id="+t+"&receiver_id="+i+"&message="+Ti.Network.encodeURIComponent(n)})}var l=Ti.Platform.osname,u=e.Record[0].UID,p=Titanium.Platform.displayCaps.platformWidth,h=Titanium.Platform.displayCaps.platformHeight,g=require("/ui/common/drawings/AvatarThumbnail"),m=Ti.UI.createWindow({orientation:Ti.UI.PORTRAIT,navBarHidden:!0,fullscreen:!0});m.orientationModes=[Ti.UI.PORTRAIT,Ti.UI.UPSIDE_PORTRAIT];var f=Titanium.UI.createView({width:"100%",height:"100%",backgroundImage:"/assets/inventoryBackground.png"});m.add(f);var T=Titanium.UI.createView({backgroundColor:"#FFFFFF",borderRadius:10,borderColor:"#333333",borderWidth:"5dip",visible:!1,height:"8%",width:p/2,zIndex:700}),I=Ti.UI.createActivityIndicator({color:"#333333",font:{fontSize:"14dip",fontWeight:"bold"},message:"Loading...",style:"iPhone OS"===Ti.Platform.name?Ti.UI.iPhone.ActivityIndicatorStyle.DARK:Ti.UI.ActivityIndicatorStyle.DARK,height:"100%",width:"100%"});T.add(I),f.add(T),function(){I.show(),T.visible=!0,I.message="Loading..."}();var v=Titanium.UI.createImageView({image:"/assets/overlayPlayerInfoCroped.png",height:"5.4%",width:"100%",top:"0%"});f.add(v);var _=Titanium.UI.createImageView({image:"/assets/iconReturn.png",height:"8%",width:"11.6%",top:"1%",right:"3%",zIndex:700});f.add(_),_.addEventListener("click",function(){m.close()});var E=Titanium.UI.createLabel({text:e.Record[0].NAME,top:"0",height:"3.1%",left:"3%",textAlign:"left",color:"#5afd9b",font:{fontWeight:"bold",fontSize:"12dip"}});f.add(E),Ti.App.fireEvent("message_status",{data:"null"});var b=Titanium.UI.createLabel({text:o.Record[0].NAME,top:"0",height:"3.1%",right:"15.6%",textAlign:"right",color:"#5afd9b",font:{fontSize:"12dip"}});f.add(b);var R,x="",A=[],w=.042*h,S=[],U=[],y=a(1,9e4),L=require("/ui/common/Functions/function");L.requestServer({success:function(){var t=JSON.parse(this.responseText);if(void 0!=t.Record){for(var i=t.Record.length-1;i>-1;i--){S[i]=Titanium.UI.createTableViewRow({className:t.Record[i].SENDER_UID==u?"MyMessage":"FriendMessage",width:"100%",allowsSelection:!1}),g({width:"100",height:"100",top:-20,left:t.Record[i].SENDER_UID==u?0:"70%"},t.Record[i].SENDER_UID==u?e.Record[0].USER_APPEARANCE:o.Record[0].USER_APPEARANCE,t.Record[i].SENDER_UID==u?e.Record[0].GENDER:o.Record[0].GENDER,i,function(e,t){null!=y&&(U[t]=e,S[t].add(U[t]))});var n=!0;t.Record[i].SENDER_UID!=u&&(n=!1),r(i,t.Record[i].MESSAGE_TEXT,t.Record[i].DATETIME,n,function(e,t,i){S[e].add(t),S[e].height=i}),A.push(S[i])}R=Ti.UI.createTableView({backgroundColor:"transparent",separatorColor:"transparent",backgroundSelectedColor:"transparent",top:"5.5%",left:"0%",height:"80%",width:"100%",data:A,separatorColor:"transparent"}),f.add(R),I.hide(),T.visible=!1,R.scrollToIndex(t.Record.length-1,{position:Titanium.UI.iPhone.TableViewScrollPosition.TOP,animated:!0})}},onerror:function(t){Ti.API.debug("STATUS: "+this.status),Ti.API.debug("TEXT: "+this.responseText),Ti.API.debug("ERROR: "+t.error),Ti.API.debug("URL: http://bonozo.com:8080/knp/get_thread_messages.php?sender_id="+e.Record[0].UID+"&receiver_id="+o.Record[0].UID),alert("There was an error retrieving the remote data. Try again.")},method:"GET",contentType:"text/xml",url:"http://bonozo.com:8080/knp/get_thread_messages.php?sender_id="+e.Record[0].UID+"&receiver_id="+o.Record[0].UID});var P="",k=Titanium.UI.createTextField({hintText:"Enter Message Here",backgroundImage:"/assets/inputButton002_up.png",paddingLeft:10,bottom:"0%",height:"10%",width:"80%",right:"0%",zIndex:600});f.add(k),k.addEventListener("focus",function(){k.setHeight="20%",("iphone"===l||"ipad"===l)&&k.animate({bottom:"45%",duration:500})}),k.addEventListener("return",function(){("iphone"===l||"ipad"===l)&&k.animate({bottom:"0%",duration:500}),""!=k.value&&c(u,o.Record[0].UID,k.value,!0,""),k.value=""});var N=Ti.UI.createImageView({image:"/assets/iconGift.png",height:"10%",width:"20%",bottom:"0%",left:"0%"});N.addEventListener("click",function(){var t=require("ui/common/MenuScreen/GiftFromMessage"),t=new t(e,o.Record[0].UID);t.open({modal:!0})}),f.add(N);var C,z="0";z=setInterval(function(){var e=require("/ui/common/Functions/function");e.requestServer({success:function(){if(C=JSON.parse(this.responseText),void 0!=C.Record)for(var e=C.Record.length-1;e>-1;e--)d(u,o.Record[0].UID,C.Record[e].MESSAGE_TEXT,!1,C.Record[e].DATETIME)},method:"GET",contentType:"text/xml",url:"http://bonozo.com:8080/knp/get_unread_messages.php?sender_id="+o.Record[0].UID+"&receiver_id="+u})},1e3),Ti.App.addEventListener("message_screen_closed",function(e){e.thread_temp_id==y&&(y=null,clearInterval(z),z=null)});m.activity;return f.addEventListener("android:back",function(){clearInterval(z),z=null}),m}module.exports=MessageScreen;